{"version":3,"names":["path","_interopRequireWildcard","require","_webpack","data","_config","_dll","_eslint","_js","_WatchMatchPlugin","_WebpackRemoveOldAssetsPlugin","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","BaseTarget","configureRules","configurator","rules","babelLoader","createBabelLoader","type","hasDependency","push","test","use","exclude","hasDevDependency","loader","configureEslint","configurePlugins","plugins","dllManifest","configureDll","mode","isProduction","optimization","config","nodeEnv","env","minify","TerserPlugin","minimizer","parallel","sourceMap","terserOptions","keep_fnames","minimize","LoaderOptionsPlugin","concatenateModules","configureDevelopmentPlugins","autoClean","WebpackRemoveOldAssetsPlugin","noEmitOnErrors","additionalEnvironmentVariables","keys","process","filter","it","startsWith","length","EnvironmentPlugin","exports","configureFileLoader","prefix","limit","name","isAncestor","file","dir","sep","parseInt","String","webpackVersion","moduleIds","namedModules","DefinePlugin","__static","join","projectDir","staticSourceDirectory","replace","HotModuleReplacementPlugin","WebpackNotifierPlugin","title","suppressSuccess","sound","commonSourceDir","commonSourceDirectory","endsWith","getDefaultRelativeSystemDependentCommonSource","dirname","alienSourceDir","getSourceDirectory","sourceDir","WatchFilterPlugin"],"sources":["../../src/targets/BaseTarget.ts"],"sourcesContent":["import * as path from \"path\"\r\nimport { DefinePlugin, EnvironmentPlugin, HotModuleReplacementPlugin, LoaderOptionsPlugin, version as webpackVersion } from \"webpack\"\r\nimport { getDefaultRelativeSystemDependentCommonSource } from \"../config\"\r\nimport { configureDll } from \"../configurators/dll\"\r\nimport { configureEslint } from \"../configurators/eslint\"\r\nimport { createBabelLoader } from \"../configurators/js\"\r\nimport { WebpackConfigurator } from \"../main\"\r\nimport { WatchFilterPlugin } from \"../plugins/WatchMatchPlugin\"\r\nimport { WebpackRemoveOldAssetsPlugin } from \"../plugins/WebpackRemoveOldAssetsPlugin\"\r\n\r\nexport class BaseTarget {\r\n  configureRules(configurator: WebpackConfigurator): void {\r\n    const rules = configurator.rules\r\n\r\n    const babelLoader = createBabelLoader(configurator)\r\n    // noinspection SpellCheckingInspection\r\n    if (configurator.type !== \"main\" && configurator.hasDependency(\"iview\")) {\r\n      rules.push({\r\n        test: /iview.src.*?js$/,\r\n        use: babelLoader\r\n      })\r\n    }\r\n\r\n    rules.push(\r\n      {\r\n        test: /\\.js$/,\r\n        exclude: /(node_modules|bower_components)/,\r\n        use: babelLoader\r\n      },\r\n      {\r\n        test: /\\.node$/,\r\n        use: \"node-loader\"\r\n      },\r\n    )\r\n\r\n    if (configurator.hasDevDependency(\"nunjucks-loader\")) {\r\n      rules.push({\r\n        test: /\\.(njk|nunjucks)$/,\r\n        loader: \"nunjucks-loader\"\r\n      })\r\n    }\r\n\r\n    configureEslint(configurator)\r\n  }\r\n\r\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\r\n    const plugins = configurator.plugins\r\n\r\n    const dllManifest = await configureDll(configurator)\r\n    const mode = configurator.isProduction ? \"production\" : \"development\"\r\n\r\n    let optimization = configurator.config.optimization\r\n    if (optimization == null) {\r\n      optimization = {}\r\n      configurator.config.optimization = optimization\r\n    }\r\n\r\n    optimization.nodeEnv = mode\r\n    configurator.config.mode = mode\r\n\r\n    if (configurator.isProduction) {\r\n      if (configurator.env.minify !== false) {\r\n        const TerserPlugin = require(\"terser-webpack-plugin\")\r\n        // noinspection SpellCheckingInspection\r\n        optimization.minimizer = [new TerserPlugin({\r\n          parallel: true,\r\n          sourceMap: true,\r\n          terserOptions: {\r\n            keep_fnames: true,\r\n          },\r\n        })]\r\n      }\r\n      optimization.minimize = true\r\n      plugins.push(new LoaderOptionsPlugin({minimize: true}))\r\n\r\n      // do not use ModuleConcatenationPlugin for HMR\r\n      // https://github.com/webpack/webpack-dev-server/issues/949\r\n      optimization.concatenateModules = true\r\n    }\r\n    else {\r\n      configureDevelopmentPlugins(configurator)\r\n    }\r\n\r\n    if (configurator.env.autoClean !== false) {\r\n      plugins.push(new WebpackRemoveOldAssetsPlugin(dllManifest))\r\n    }\r\n\r\n    optimization.noEmitOnErrors = true\r\n\r\n    const additionalEnvironmentVariables = Object.keys(process.env).filter(it => it.startsWith(\"ELECTRON_WEBPACK_\"))\r\n    if (additionalEnvironmentVariables.length > 0) {\r\n      plugins.push(new EnvironmentPlugin(additionalEnvironmentVariables))\r\n    }\r\n  }\r\n}\r\n\r\nexport function configureFileLoader(prefix: string, limit = 10 * 1024) {\r\n  return {\r\n    limit,\r\n    name: `${prefix}/[name]--[folder].[ext]`\r\n  }\r\n}\r\n\r\nfunction isAncestor(file: string, dir: string) {\r\n  if (file === dir) {\r\n    return true\r\n  }\r\n  return file.length > dir.length && file[dir.length] === path.sep && file.startsWith(dir)\r\n}\r\n\r\nfunction configureDevelopmentPlugins(configurator: WebpackConfigurator) {\r\n  const optimization = configurator.config.optimization!!\r\n  if (parseInt(String(webpackVersion), 10) >= 5) {\r\n    optimization.moduleIds = 'named'\r\n  }\r\n  else {\r\n    optimization.namedModules = true\r\n  }\r\n\r\n  const plugins = configurator.plugins\r\n  plugins.push(new DefinePlugin({\r\n    __static: `\"${path.join(configurator.projectDir, configurator.staticSourceDirectory).replace(/\\\\/g, \"\\\\\\\\\")}\"`,\r\n    \"process.env.NODE_ENV\": configurator.isProduction ? \"\\\"production\\\"\" : \"\\\"development\\\"\"\r\n  }))\r\n\r\n  plugins.push(new HotModuleReplacementPlugin())\r\n\r\n  if (configurator.hasDevDependency(\"webpack-build-notifier\")) {\r\n    const WebpackNotifierPlugin = require(\"webpack-build-notifier\")\r\n    plugins.push(new WebpackNotifierPlugin({\r\n      title: `Webpack - ${configurator.type}`,\r\n      suppressSuccess: \"initial\",\r\n      sound: false,\r\n    }))\r\n  }\r\n\r\n  if (configurator.hasDevDependency(\"webpack-notifier\")) {\r\n    const WebpackNotifierPlugin = require(\"webpack-notifier\")\r\n    plugins.push(new WebpackNotifierPlugin({title: `Webpack - ${configurator.type}`}))\r\n  }\r\n\r\n  // watch common code\r\n  let commonSourceDir = configurator.commonSourceDirectory\r\n  if (commonSourceDir.endsWith(path.sep + getDefaultRelativeSystemDependentCommonSource())) {\r\n    // not src/common, because it is convenient to just put some code into src to use it\r\n    commonSourceDir = path.dirname(commonSourceDir)\r\n  }\r\n\r\n  const alienSourceDir = configurator.getSourceDirectory(configurator.type === \"main\" ? \"renderer\" : \"main\")\r\n  const sourceDir = configurator.getSourceDirectory(configurator.type)\r\n  configurator.plugins.push(new WatchFilterPlugin(file => {\r\n    if (sourceDir != null && isAncestor(file, sourceDir)) {\r\n      return true\r\n    }\r\n    else if (file === commonSourceDir || isAncestor(file, commonSourceDir!!)) {\r\n      return alienSourceDir == null || !isAncestor(file, alienSourceDir)\r\n    }\r\n    else {\r\n      return false\r\n    }\r\n  }, require(\"debug\")(`electron-webpack:watch-${configurator.type}`)))\r\n}\r\n"],"mappings":"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"}
