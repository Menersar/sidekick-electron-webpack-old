{"version":3,"names":["_child_process","data","require","path","_interopRequireWildcard","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","debug","run","program","args","options","isWin","process","platform","spawn","join","__dirname","concat","ChildProcessManager","constructor","child","debugLabel","promiseNotifier","mainProcessExitCleanupCallback","callback","resolve","enabled","stdin","end","Buffer","from","kill","on","code","message","reject","Error","stderr","write","exports","PromiseNotifier","_resolve","_reject","r","error"],"sources":["../../src/dev/ChildProcessManager.ts"],"sourcesContent":["import { ChildProcess, spawn, SpawnOptions } from \"child_process\"\r\nimport * as path from \"path\"\r\n\r\nconst debug = require(\"debug\")(\"electron-webpack\")\r\n\r\nexport function run(program: string, args: Array<string>, options: SpawnOptions) {\r\n  const isWin = process.platform === \"win32\"\r\n  return spawn(isWin ? path.join(__dirname, \"../../vendor/runnerw.exe\") : program, isWin ? [program].concat(args) : args, options)\r\n}\r\n\r\nexport class ChildProcessManager {\r\n  // noinspection TypeScriptFieldCanBeMadeReadonly\r\n  private mainProcessExitCleanupCallback: (() => void) | null = null\r\n  // noinspection TypeScriptFieldCanBeMadeReadonly\r\n  private child: ChildProcess | null\r\n\r\n  constructor(child: ChildProcess, debugLabel: string, promiseNotifier: PromiseNotifier | null) {\r\n    this.child = child\r\n\r\n    require(\"async-exit-hook\")((callback: () => void) => {\r\n      this.mainProcessExitCleanupCallback = callback\r\n      const child = this.child\r\n      if (child == null) {\r\n        return\r\n      }\r\n\r\n      this.child = null\r\n\r\n      if (promiseNotifier != null) {\r\n        promiseNotifier.resolve()\r\n      }\r\n\r\n      if (debug.enabled) {\r\n        debug(`Send SIGINT to ${debugLabel}`)\r\n      }\r\n\r\n      if (process.platform === \"win32\") {\r\n        child.stdin!!.end(Buffer.from([5, 5]))\r\n      }\r\n      else {\r\n        child.kill(\"SIGINT\")\r\n      }\r\n    })\r\n\r\n    child.on(\"close\", code => {\r\n      const mainProcessExitCleanupCallback = this.mainProcessExitCleanupCallback\r\n      if (mainProcessExitCleanupCallback != null) {\r\n        this.mainProcessExitCleanupCallback = null\r\n        mainProcessExitCleanupCallback()\r\n      }\r\n\r\n      const child = this.child\r\n      if (child == null) {\r\n        return\r\n      }\r\n\r\n      this.child = null\r\n\r\n      const message = `${debugLabel} exited with code ${code}`\r\n\r\n      if (promiseNotifier != null) {\r\n        promiseNotifier.reject(new Error(message))\r\n      }\r\n\r\n      if (code === 0) {\r\n        if (debug.enabled) {\r\n          debug(message)\r\n          // otherwise no newline in the terminal\r\n          process.stderr.write(\"\\n\")\r\n        }\r\n      }\r\n      else {\r\n        process.stderr.write(`${message}\\n`)\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\nexport class PromiseNotifier {\r\n  constructor(private _resolve: (() => void) | null, private _reject: ((error: Error) => void) | null) {\r\n  }\r\n\r\n  resolve() {\r\n    const r = this._resolve\r\n    if (r != null) {\r\n      this._resolve = null\r\n      r()\r\n    }\r\n  }\r\n\r\n  reject(error: Error) {\r\n    if (this._resolve != null) {\r\n      this._resolve = null\r\n    }\r\n\r\n    const _reject = this._reject\r\n    if (_reject != null) {\r\n      this._reject = null\r\n      _reject(error)\r\n    }\r\n  }\r\n}"],"mappings":"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"}
